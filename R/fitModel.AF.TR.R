
#' Amplification Factor AF, from Stewart Et Al. 2016
#'
#' @param .x GMDP object
#' @param q Double. quantile
#' @param Tn Double. Natural Period
#' @param Vs30 Double. Vs30 in m/s
#' @param Vref Double. Reference Vs30 in m/s
#' @param Vl Double. Lower limit Vs30 in m/s
#' @param Vu Double. Upper limit Vs30 in m/s
#'
#' @return data.table
#' @export fitModel.AF.TR
#'
#' @import data.table
#' @importFrom stats lm
#' @importFrom stats predict.lm
#' @importFrom stats approxfun
#'
#' @examples
#'

fitModel.AF.TR <- function(.x,q=0.50,Tn, Vs30, Vref, Vl = 200, Vu = 2000) {

  on.exit(expr = {
    rm(list = ls())
  }, add = TRUE)



  OK <- length(Vref) == 1 & length(Vs30) == 1
  # OK <- OK & (Vref %in% c(3000, 760))
  stopifnot(OK)
  if (Vs30 == Vref) {
    DT <- data.table::data.table(
      .x,
      Vref = Vref,
      Vs30 = Vs30,
      SID = Vs30toSID(Vs30),
      muLnPGA = 0,
      muL = 0,
      muI = 0,
      muNL = 0,
      muLnAF = 0,
      AF = 1,
      sdL = 0,
      sdI = 0,
      sdNL = 0,
      sdLnAF = 0,
      SM = "aep"
    )
    return(DT)
  }
  PGAref <- .x$PGAref[1]

  # Interpolated tables ----
  cI <- stats::approxfun(
    x = c(0.00, 0.08, 0.10, 0.20, 0.30, 0.40, 0.50, 0.80, 1.00, 2.00, 3.00, 4.00, 5.00, 20.00),
    y = c(-0.359, -0.359, -0.344, -0.408, -0.416, -0.418, -0.446, -0.527, -0.554, -0.580, -0.593, -0.597, -0.582, -0.582),
    ties = mean
  )
  V1I <- stats::approxfun(
    x = c(0.00, 0.08, 0.10, 0.20, 0.30, 0.40, 0.50, 0.80, 1.00, 2.00, 3.00, 4.00, 5.00, 20.00),
    y = c(333, 333, 319, 314, 200, 200, 200, 230, 278, 286, 313, 322, 325, 325),
    ties = mean
  )

  V2I <- stats::approxfun(
    x = c(0.00, 0.08, 0.10, 0.20, 0.30, 0.40, 0.50, 0.80, 1.00, 2.00, 3.00, 4.00, 5.00, 20.00),
    y = c(760, 760, 760, 760, 760, 760, 764, 942, 1103, 1201, 876, 881, 855, 855),
    ties = mean
  )

  VfI <- stats::approxfun(
    x = c(0.00, 0.08, 0.10, 0.20, 0.30, 0.40, 0.50, 0.80, 1.00, 2.00, 3.00, 4.00, 5.00, 20.00),
    y = c(333, 333, 319, 314, 250, 250, 280, 280, 300, 300, 313, 322, 325, 325),
    ties = mean
  )

  sdVcI <- stats::approxfun(
    x = c(0.00, 0.08, 0.10, 0.20, 0.30, 0.40, 0.50, 0.80, 1.00, 2.00, 3.00, 4.00, 5.00, 20.00),
    y = c(0.268, 0.268, 0.270, 0.251, 0.225, 0.225, 0.225, 0.225, 0.225, 0.259, 0.306, 0.340, 0.340, 0.340),
    ties = mean
  )

  sdLI <- stats::approxfun(
    x = c(0.00, 0.08, 0.10, 0.20, 0.30, 0.40, 0.50, 0.80, 1.00, 2.00, 3.00, 4.00, 5.00, 20.00),
    y = c(0.281, 0.281, 0.263, 0.306, 0.276, 0.275, 0.311, 0.334, 0.377, 0.548, 0.538, 0.435, 0.400, 0.400),
    ties = mean
  )


  sdUI <- stats::approxfun(
    x = c(0.00, 0.08, 0.10, 0.20, 0.30, 0.40, 0.50, 0.80, 1.00, 2.00, 3.00, 4.00, 5.00, 20.00),
    y = c(0.472, 0.472, 0.470, 0.334, 0.381, 0.381, 0.323, 0.308, 0.361, 0.388, 0.551, 0.585, 0.587, 0.587),
    ties = mean
  )

  F760I <- stats::approxfun(
    x = c(0.00, 0.01, 0.011, 0.012, 0.013, 0.014, 0.015, 0.016, 0.017, 0.019, 0.02, 0.022, 0.023, 0.025, 0.027, 0.028, 0.031, 0.033, 0.035, 0.038, 0.04, 0.043, 0.046, 0.05, 0.053, 0.057, 0.061, 0.066, 0.071, 0.076, 0.081, 0.087, 0.093, 0.1, 0.107, 0.115, 0.123, 0.132, 0.142, 0.152, 0.163, 0.175, 0.187, 0.201, 0.215, 0.231, 0.248, 0.266, 0.285, 0.305, 0.327, 0.351, 0.376, 0.404, 0.433, 0.464, 0.498, 0.534, 0.572, 0.614, 0.658, 0.705, 0.756, 0.811, 0.87, 0.933, 1, 1.072, 1.15, 1.233, 1.322, 1.417, 1.52, 1.63, 1.748, 1.874, 2.009, 2.154, 2.31, 2.477, 2.656, 2.848, 3.054, 3.275, 3.511, 3.765, 4.037, 4.329, 4.642, 4.977, 5.337, 5.722, 6.136, 6.579, 7.055, 7.565, 8.111, 8.697, 9.326, 10, 20),
    y = c(0.185, 0.185, 0.185, 0.185, 0.185, 0.185, 0.185, 0.185, 0.185, 0.185, 0.185, 0.185, 0.189, 0.195, 0.203, 0.212, 0.224, 0.238, 0.252, 0.267, 0.283, 0.3, 0.318, 0.337, 0.356, 0.377, 0.4, 0.425, 0.454, 0.475, 0.512, 0.558, 0.613, 0.674, 0.73, 0.76, 0.759, 0.714, 0.647, 0.586, 0.534, 0.488, 0.449, 0.419, 0.39, 0.362, 0.332, 0.301, 0.278, 0.27, 0.262, 0.242, 0.224, 0.209, 0.197, 0.186, 0.175, 0.166, 0.157, 0.15, 0.142, 0.135, 0.127, 0.12, 0.111, 0.103, 0.095, 0.088, 0.083, 0.08, 0.078, 0.078, 0.077, 0.077, 0.078, 0.079, 0.079, 0.078, 0.076, 0.075, 0.074, 0.073, 0.073, 0.072, 0.07, 0.068, 0.066, 0.065, 0.065, 0.064, 0.063, 0.061, 0.06, 0.058, 0.057, 0.056, 0.056, 0.055, 0.055, 0.053, 0.053),
    ties = mean
  )

  sd760I <- stats::approxfun(
    x = c(0.00, 0.01, 0.011, 0.012, 0.013, 0.014, 0.015, 0.016, 0.017, 0.019, 0.02, 0.022, 0.023, 0.025, 0.027, 0.028, 0.031, 0.033, 0.035, 0.038, 0.04, 0.043, 0.046, 0.05, 0.053, 0.057, 0.061, 0.066, 0.071, 0.076, 0.081, 0.087, 0.093, 0.1, 0.107, 0.115, 0.123, 0.132, 0.142, 0.152, 0.163, 0.175, 0.187, 0.201, 0.215, 0.231, 0.248, 0.266, 0.285, 0.305, 0.327, 0.351, 0.376, 0.404, 0.433, 0.464, 0.498, 0.534, 0.572, 0.614, 0.658, 0.705, 0.756, 0.811, 0.87, 0.933, 1, 1.072, 1.15, 1.233, 1.322, 1.417, 1.52, 1.63, 1.748, 1.874, 2.009, 2.154, 2.31, 2.477, 2.656, 2.848, 3.054, 3.275, 3.511, 3.765, 4.037, 4.329, 4.642, 4.977, 5.337, 5.722, 6.136, 6.579, 7.055, 7.565, 8.111, 8.697, 9.326, 10, 20),
    y = c(0.434, 0.434, 0.434, 0.434, 0.434, 0.434, 0.434, 0.434, 0.434, 0.434, 0.434, 0.434, 0.432, 0.429, 0.422, 0.414, 0.404, 0.393, 0.387, 0.387, 0.39, 0.39, 0.381, 0.363, 0.34, 0.32, 0.308, 0.306, 0.312, 0.322, 0.335, 0.346, 0.357, 0.366, 0.372, 0.37, 0.351, 0.323, 0.284, 0.253, 0.234, 0.222, 0.214, 0.214, 0.207, 0.195, 0.177, 0.156, 0.141, 0.131, 0.124, 0.117, 0.115, 0.112, 0.113, 0.111, 0.105, 0.104, 0.113, 0.123, 0.132, 0.139, 0.138, 0.133, 0.13, 0.128, 0.124, 0.118, 0.112, 0.108, 0.11, 0.114, 0.12, 0.122, 0.124, 0.124, 0.118, 0.113, 0.112, 0.111, 0.109, 0.108, 0.111, 0.116, 0.12, 0.122, 0.12, 0.116, 0.112, 0.108, 0.104, 0.1, 0.096, 0.091, 0.087, 0.082, 0.078, 0.074, 0.07, 0.069, 0.069),
    ties = mean
  )

  f3I <- stats::approxfun(
    x = c(0.0, 0.08, 0.1, 0.2, 0.3, 0.4, 0.5, 0.8, 1., 2., 3., 4., 5., 10., 20.),
    y = c(0.16249, 0.16249, 0.15083, 0.12815, 0.1307, 0.09414, 0.09888, 0.07357, 0.04367, 0.00164, 0.00746, 0.00269, 0.00242, 0.05329, 0.05329),
    ties = mean
  )

  f4I <- stats::approxfun(
    x = c(0.0, 0.08, 0.1, 0.2, 0.3, 0.4, 0.5, 0.8, 1., 2., 3., 4., 5., 10., 20.),
    y = c(-0.50667, -0.50667, -0.44661, -0.30481, -0.22825, -0.11591, -0.07793, -0.01592, -0.00478, -0.00236, -0.00626, -0.00331, -0.00256, -0.00631, -0.00631),
    ties = mean
  )

  f5I <- stats::approxfun(
    x = c(0.0, 0.08, 0.1, 0.2, 0.3, 0.4, 0.5, 0.8, 1., 2., 3., 4., 5., 10., 20.),
    y = c(-0.00273, -0.00273, -0.00335, -0.00488, -0.00655, -0.00872, -0.01028, -0.01515, -0.01823, -0.01296, -0.01043, -0.01215, -0.01325, -0.01403, -0.01403),
    ties = mean
  )

  VcI <- stats::approxfun(
    x = c(0.0, 0.08, 0.1, 0.2, 0.3, 0.4, 0.5, 0.8, 1., 2., 3., 4., 5., 10., 20.),
    y = c(2990, 2990, 2990, 1533, 1152, 1018, 938, 832, 951, 879, 894, 875, 856, 837, 837),
    ties = mean
  )

  sdcI <- stats::approxfun(
    # Te={},
    # \[Sigma]c={}
    x = c(0.0, 0.08, 0.1, 0.2, 0.3, 0.4, 0.5, 0.8, 1., 2., 3., 4., 5., 10., 20.),
    y = c(0.12, 0.12, 0.12, 0.12, 0.15, 0.15, 0.15, 0.1, 0.06, 0.04, 0.04, 0.03, 0.02, 0.02, 0.02),
    ties = mean
  )

  # Mean Value ----
  muLnPGA <- log(PGAref)
  if (Vref == 760) {
    C7603000 <- 2.275
  }
  if (Vref == 3000) {
    C7603000 <- 1.0
  }

  if (Vs30 <= V1I(Tn)) {
    muL <- cI(Tn) * log(V1I(Tn) / 760)
  }

  if (V1I(Tn) < Vs30 & Vs30 <= V2I(Tn)) {
    muL <- cI(Tn) * log(Vs30 / 760)
  }

  if (Vs30 > V2I(Tn)) {
    muL <- cI(Tn) * log(V2I(Tn) / 760) + cI(Tn) / 2 * log(Vs30 / V2I(Tn))
  }

  a <- f4I(Tn) * (exp(f5I(Tn) * (min(Vs30, 3000) - 360)) - exp(f5I(Tn) * (3000 - 360)))

  b <- C7603000 * f3I(Tn)

  if (Vs30 < VcI(Tn)) {
    muNL <- a * log((exp(muLnPGA) / b + 1))
  }
  if (Vs30 >= VcI(Tn)) {
    muNL <- 0
  }

  if (Vref == 3000) {
    muI <- F760I(Tn)
  }
  if (Vref == 760) {
    muI <- 0
  }

  muLnAF <- muL + muI + muNL

  # Standard Deviation ----
  if (Vs30 <= VfI(Tn)) {
    sdL <- sdLI(Tn) - 2 * (sdLI(Tn) - sdVcI(Tn)) * (Vs30 - Vl) / (VfI(Tn) - Vl) + (sdLI(Tn) - sdVcI(Tn)) * (Vs30 - Vl)^2 / (VfI(Tn) - Vl)^2
  }

  if (VfI(Tn) < Vs30 & Vs30 <= V2I(Tn)) {
    sdL <- sdVcI(Tn)
  }
  if (Vs30 > V2I(Tn)) {
    sdL <- sdVcI(Tn) + (sdUI(Tn) - sdVcI(Tn)) * (Vs30 - V2I(Tn))^2 / (Vu - V2I(Tn))^2
  }

  if (Vs30 < 300) {
    sdNL <- sdcI(Tn)
  }

  if (300 <= Vs30 & Vs30 < 1000) {
    sdNL <- -sdcI(Tn) * log(Vs30 / 300) / log(1000 / 300) + sdcI(Tn)
  }

  if (Vs30 >= 1000) {
    sdNL <- 0
  }


  if (Vref == 3000) {
    sdI <- sd760I(Tn)
  }
  if (Vref == 760) {
    sdI <- 0
  }
  a <- f4I(Tn) * (exp(f5I(Tn) * (min(Vs30, 3000) - 360)) - exp(f5I(Tn) * (3000 - 360)))

  b <- C7603000 * f3I(Tn)
  sdLnAF <- sqrt(sdL^2 + sdI^2 + sdNL^2)
  if(q!="mean"){
    p <- as.numeric(q)
    beta <- qnorm(p=p,sd=sdLnAF) |> exp()
  } else {
    beta <- exp(1/2*sdLnAF^2)
  }
  DT <- data.table::data.table(
    .x,
    Vref = Vref,
    Vs30 = Vs30,
    SID = Vs30toSID(Vs30),
    muLnPGA = muLnPGA,
    muL = muL,
    muI = muI,
    muNL = muNL,
    muLnAF = muLnAF,
    AF = exp(muLnAF)*beta,
    sdL = sdL,
    sdI = sdI,
    sdNL = sdNL,
    sdLnAF = sdLnAF,
    SM = "gmdp"
  )

  return(DT)
}
